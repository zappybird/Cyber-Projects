"""
pypi_client.py — Client for the PyPI JSON API.

PyPI exposes package metadata at:
    GET https://pypi.org/pypi/{package_name}/json

The response includes the latest stable release, all historical versions,
and per-version metadata such as upload date and yanked status.

We use this to:
  - Determine the latest non-pre-release version of a package
  - Report whether a scanned dependency is out of date

ETag/If-None-Match caching will be added in a later step to avoid
re-fetching data for packages whose metadata hasn't changed.

Reference: https://docs.pypi.org/api/json/
"""

from __future__ import annotations

import json
import urllib.request
from dataclasses import dataclass
from typing import Optional

PYPI_JSON_URL = "https://pypi.org/pypi/{package}/json"


@dataclass
class PackageInfo:
    """
    Relevant metadata for a package fetched from PyPI.

    Attributes:
        name:           Canonical package name as PyPI knows it.
        latest_stable:  The latest non-pre-release version string, or None.
        latest_any:     The absolute latest version (may be a pre-release).
        all_versions:   All available versions, unsorted.
    """
    name: str
    latest_stable: Optional[str]
    latest_any: Optional[str]
    all_versions: list[str]


def fetch_latest_version(
    package_name: str,
    *,
    include_prereleases: bool = False,
) -> Optional[PackageInfo]:
    """
    Retrieve version information for a package from PyPI.

    Args:
        package_name:        The package to look up (case-insensitive).
        include_prereleases: If True, pre-release versions are included
                             when determining the "latest" version.

    Returns:
        A PackageInfo object, or None if the package was not found on PyPI.

    Note:
        Version comparison uses PEP 440 semantics. The logic for that will
        live in a dedicated `version_utils.py` module added in a later step.
    """
    # TODO: Build URL from PYPI_JSON_URL template.
    # TODO: GET request via urllib.request (no requests lib).
    # TODO: Handle 404 → return None; other errors → raise.
    # TODO: Parse JSON, extract version list, filter yanked releases.
    # TODO: Use PEP 440 parsing (future version_utils) to find latest stable.
    raise NotImplementedError


def _parse_pypi_response(
    response_data: dict,
    *,
    include_prereleases: bool = False,
) -> PackageInfo:
    """
    Convert a raw PyPI JSON API response into a PackageInfo object.

    Args:
        response_data:       The parsed JSON dict from PyPI.
        include_prereleases: Whether pre-releases count as "latest".

    Returns:
        A populated PackageInfo instance.

    Note:
        Yanked releases (PEP 592) should be excluded from consideration.
        A release is yanked if any of its file entries has "yanked": True.
    """
    # TODO: response_data["info"]["name"] → canonical name
    # TODO: response_data["releases"] → dict of version → list of file dicts
    # TODO: Filter out yanked versions
    # TODO: Filter out pre-releases unless include_prereleases is True
    # TODO: Sort remaining versions by PEP 440 rules to find latest
    raise NotImplementedError