"""
pyproject_parser.py — Parser for pyproject.toml dependency declarations.

pyproject.toml (PEP 518 / PEP 621) can declare dependencies in several
locations depending on which build backend is in use:

  [project]
  dependencies = ["requests>=2.28", "flask>=2.0"]    ← PEP 621 standard

  [project.optional-dependencies]
  dev = ["pytest>=7.0"]                               ← optional groups

  [tool.poetry.dependencies]
  requests = "^2.28"                                  ← Poetry-specific format

We handle PEP 621 first. Poetry support will be added in a future step
because Poetry uses a different version constraint syntax (^, ~, *).

Python 3.11+ has tomllib in the stdlib. For 3.10 and below we need
tomli (a third-party backport). We handle both gracefully.

Reference: https://packaging.python.org/en/latest/specifications/pyproject-toml/
"""

from __future__ import annotations

from pathlib import Path
from typing import Any

from pydepscan.parsers import Dependency

# Graceful stdlib vs backport import for TOML parsing.
# tomllib is available in Python 3.11+; tomli is its backport.
try:
    import tomllib  # type: ignore[import]
except ImportError:
    try:
        import tomli as tomllib  # type: ignore[import]
    except ImportError:
        tomllib = None  # type: ignore[assignment]
        # We'll raise a helpful error at parse time if this is None.


def parse_pyproject(file_path: Path) -> list[Dependency]:
    """
    Parse a pyproject.toml file and extract all declared dependencies.

    Supports:
      - PEP 621 [project].dependencies
      - PEP 621 [project.optional-dependencies] (all groups combined)
      - (Future) [tool.poetry.dependencies]

    Args:
        file_path: Path to the pyproject.toml file.

    Returns:
        A list of Dependency objects from all supported dependency sections.

    Raises:
        FileNotFoundError: If file_path does not exist.
        ImportError: If neither tomllib nor tomli is available.
        ValueError: If the TOML is malformed.
    """
    # TODO: Check tomllib is not None; raise ImportError with install hint.
    # TODO: Open file in binary mode (tomllib requires bytes).
    # TODO: Call tomllib.load(f) to parse the TOML.
    # TODO: Dispatch to _parse_pep621() and (later) _parse_poetry().
    # TODO: Deduplicate if a package appears in multiple sections.
    raise NotImplementedError


def _parse_pep621(data: dict[str, Any], source_file: str) -> list[Dependency]:
    """
    Extract dependencies from the PEP 621 [project] table.

    PEP 621 stores dependencies as a list of PEP 508 strings, e.g.:
        dependencies = ["requests>=2.28.0", "click>=8.0"]

    Optional dependency groups live under [project.optional-dependencies]:
        [project.optional-dependencies]
        dev = ["pytest>=7.0"]

    Args:
        data:        The full parsed TOML dict.
        source_file: File path string, attached to each Dependency for reporting.

    Returns:
        A list of Dependency objects from both required and optional deps.
    """
    # TODO: data.get("project", {}).get("dependencies", []) → required deps
    # TODO: data.get("project", {}).get("optional-dependencies", {}) → groups
    # TODO: Flatten all groups into one list alongside required deps.
    # TODO: Each string is a PEP 508 specifier → reuse _parse_specifier_line
    #       from requirements_parser (or a shared utility once we refactor).
    raise NotImplementedError


def _parse_poetry(data: dict[str, Any], source_file: str) -> list[Dependency]:
    """
    Extract dependencies from the [tool.poetry.dependencies] table.

    Poetry uses a different syntax from PEP 508:
      requests = "^2.28"   (caret = compatible release, similar to ~=)
      flask = {version = ">=2.0", extras = ["async"]}

    Args:
        data:        The full parsed TOML dict.
        source_file: File path string for reporting.

    Returns:
        A list of Dependency objects. Poetry version constraints will be
        normalised to PEP 440 equivalents in a future version_utils step.
    """
    # TODO: data.get("tool", {}).get("poetry", {}).get("dependencies", {})
    # TODO: Skip the special "python" key (it's a Python version constraint).
    # TODO: Handle both string form and dict form of version specs.
    # NOTE: Poetry constraint conversion (^ → ~=, etc.) deferred to later.
    raise NotImplementedError